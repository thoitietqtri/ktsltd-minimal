<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN TỰ ĐỘNG - QUẢNG TRỊ</title>
  <style>
    :root{--bg:#f7f9ff;--card:#fff;--txt:#0f172a;--muted:#64748b;--pri:#1d4ed8;--ok:#16a34a;--err:#dc2626;--grid:#e2e8f0;--grid-strong:#94a3b8}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--grid);padding:18px 16px;z-index:5}
    .mega-title{margin:0;text-align:center;color:var(--pri);font-weight:800;letter-spacing:.5px}
    .mega-title .l1{font-size:28px;text-transform:uppercase}

    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:12px;color:var(--muted);display:block;margin:4px 0}
    input,select,button{width:100%;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
    button{background:var(--pri);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#64748b}
    .hint{font-size:12px;color:var(--muted)}
    .status{font-size:12px;margin-top:6px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}

    .grid{display:grid;grid-template-rows:1fr;height:calc(100vh - 160px)}
    .scroll{overflow:auto;border:1px solid var(--grid);border-radius:8px;background:#fff}

    /* Bảng log: font 12px, căn giữa, viền đậm */
    table{width:max-content;border-collapse:separate;border-spacing:0;font-size:12px;white-space:nowrap}
    thead th, tbody td{
      padding:8px 10px;
      border-right:1.5px solid var(--grid-strong);
      border-bottom:1.5px solid var(--grid-strong);
      text-align:center; vertical-align:middle;
    }
    thead th:first-child, tbody td:first-child{border-left:1.5px solid var(--grid-strong)}
    thead th{position:sticky;top:0;background:#f1f5f9;z-index:2;border-bottom-color:#64748b;font-weight:700}
    thead th:first-child{left:0;z-index:4}
    tbody td:first-child{position:sticky;left:0;background:#fff;z-index:3;text-align:left}

    /* Ô thời gian: 2 cột, không bị cắt bên phải */
    .dt{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}
    .dt > div{min-width:0}
    .dt input[type="datetime-local"]{
      width:100%;
      background:#f8fafc;border:1.5px solid var(--grid-strong);
      height:42px;font-weight:600;letter-spacing:.2px;border-radius:10px;
      padding-right:34px; /* chừa chỗ icon lịch */
    }

    .hide{display:none}
    #multiSelect{height:200px}

    @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1 class="mega-title">
    <span class="l1">THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN TRÊN ĐỊA BÀN TỈNH QUẢNG TRỊ - PHỤC VỤ PCTT</span>
  </h1>
</header>

<div class="wrap">
  <!-- Panel trái -->
  <section class="card">
    <div class="row">
      <button id="btnAutoXlsx">Tải tự động</button>
      <input type="file" id="fileXlsx" accept=".xlsx" />
    </div>
    <div id="xlsxStatus" class="status">Chưa tải file Excel.</div>
    <div class="hint">Đặt <b>index.html</b> cùng thư mục với <b>thamso_khaithac.xlsx</b> rồi bấm “Tải tự động”; hoặc chọn file thủ công. Không đổi tên cột: <code>matram, tentram, matinh, Tab, sophut, tinhtong</code>.</div>

    <div style="margin-top:10px">
      <label>Passcode (nếu API yêu cầu)</label>
      <input id="passcode" type="text" placeholder="để trống nếu không cần">
    </div>

    <hr>

    <div id="multiStationBox">
      <label>Chọn các trạm (Giữ Ctrl/Shift để chọn nhiều)</label>
      <select id="multiSelect" multiple></select>
      <div class="hint">Mặc định chọn 4 trạm đầu tiên. Có thể chọn nhiều trạm; bảng sẽ có <b>thanh kéo ngang</b> khi vượt rộng.</div>
    </div>

    <!-- Ô thời gian – bản sửa -->
    <div class="dt" style="margin-top:8px">
      <div>
        <label>Bắt đầu</label>
        <input type="datetime-local" id="startDt">
      </div>
      <div>
        <label>Kết thúc</label>
        <input type="datetime-local" id="endDt">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Chu kỳ (sophut)</label><input type="number" id="sophut" min="1" step="1" value="60"></div>
      <div><label>ten_table (mặc định lấy theo Excel)</label><input id="tenTable" placeholder="để trống để lấy theo Excel"></div>
    </div>

    <div style="margin-top:8px"><label><input type="checkbox" id="tinhtong"> Tính tổng theo ngày (tinhtong=1)</label></div>

    <div class="row" style="margin-top:10px">
      <button id="btnFetch">Lấy dữ liệu</button>
      <button class="secondary" id="btnClear">Xoá kết quả</button>
    </div>
  </section>

  <!-- Khung log -->
  <section class="grid">
    <div class="scroll">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ===== CẤU HÌNH ===== */
const RAW_API_BASE = "http://203.209.181.170:2018";
const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1") ? "/api" : RAW_API_BASE;
const DEFAULT_XLSX_PATH = "./thamso_khaithac.xlsx";
const EXCEL_SHEET = "KhaibaoQuangtri";

/* ===== TIỆN ÍCH ===== */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,"0");
const toLocalDatetimeValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
const quote = s => `'${s}'`;
const buildUrl = p => `${API_BASE}/API_TTB/JSON/solieu.php?` + new URLSearchParams(p).toString();

/* ===== ĐỌC EXCEL ===== */
let stations=[];
function normalizeRow(r){
  const pick=(a,b)=> (a!==undefined && a!=='')?a:b;
  return { matram:String(pick(r.matram,r.MATRAM)||'').trim(), tentram:String(pick(r.tentram,r.TENTRAM)||'').trim(), matinh:pick(r.matinh,r.MATINH)||'', Tab:String(pick(r.Tab,r.tab)||'').trim(), sophut:Number(pick(r.sophut,r.SOPHUT)||60)||60, tinhtong:Number(pick(r.tinhtong,r.TINHTONG)||0)||0 };
}
function loadFromWorkbook(wb){
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  stations = arr.map(normalizeRow).filter(r=>r.matram);
  if (!stations.length) throw new Error('Không đọc được danh sách trạm từ Excel.');
  $('#xlsxStatus').className='status ok';
  $('#xlsxStatus').textContent=`Đã nạp ${stations.length} trạm.`;
  fillStationSelects();
}
async function tryAutoLoadExcel(){
  $('#xlsxStatus').textContent='Đang tải thamso_khaithac.xlsx…';
  const res = await fetch(DEFAULT_XLSX_PATH);
  if (!res.ok) throw new Error('Không thấy ./thamso_khaithac.xlsx');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  loadFromWorkbook(wb);
}

/* ===== UI ===== */
function fillStationSelects(){
  const selM=$('#multiSelect'); selM.innerHTML='';
  stations.forEach((r,i)=>{
    const o=document.createElement('option');
    // HIỂN THỊ CHỈ TÊN TRẠM — KHÔNG kèm “— mã trạm”
    o.textContent=(r.tentram||'(không tên)').trim();
    o.value=i;
    selM.appendChild(o);
  });
  for(let i=0;i<Math.min(4,stations.length);i++){ selM.options[i].selected=true; }
}
function renderTable(rows){
  const thead=$('#thead'), tbody=$('#tbody'); thead.innerHTML=''; tbody.innerHTML='';
  if(!Array.isArray(rows)||!rows.length){ thead.innerHTML='<th>(trống)</th>'; return; }
  const cols=Object.keys(rows[0]);
  thead.innerHTML=cols.map(c=>`<th>${c}</th>`).join('');
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=cols.map(c=>`<td>${r[c]??''}</td>`).join('');
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);
}

/* Ghép bảng theo thời gian */
function pickField(row, keys){ for(const k of keys){ if(row[k]!==undefined && row[k]!==null && row[k]!=='' ) return row[k]; } }
const TIME_KEYS=['thoigian','Thoigian','thoigian_SL','Thoigian_SL','ThoiGian','ThoiGian_SL','time','datetime','date','Ngay','NgayGio','ngaygio'];
const VALUE_KEYS=['solieu','SoLieu','Solieu','GiaTri','giatri','mucnuoc','MucNuoc','value','LuongMua','luongmua','Mua'];
const normTime=t=> (t==null?'':String(t).trim().replace('T',' '));

function pivotByTime(datasetMap){
  const timeIndex=new Map();
  const stationNames=Object.keys(datasetMap);
  for(const name of stationNames){
    const rows=datasetMap[name]||[];
    for(const r of rows){
      const t=normTime(pickField(r,TIME_KEYS));
      const v=pickField(r,VALUE_KEYS);
      if(!t) continue;
      if(!timeIndex.has(t)) timeIndex.set(t,{"thoi gian":t});
      timeIndex.get(t)[name]=v;
    }
  }
  const out=Array.from(timeIndex.values());
  out.sort((a,b)=>String(a["thoi gian"]).localeCompare(String(b["thoi gian"])));
  return out.map(r=>{ const obj={"thoi gian":r["thoi gian"]}; for(const n of stationNames){ obj[n]=(r[n]!==undefined?r[n]:""); } return obj; });
}

/* ===== LUỒNG CHÍNH ===== */
async function init(){
  const now=new Date(), start=new Date(now.getTime()-36*3600*1000);
  $('#startDt').value=toLocalDatetimeValue(start);
  $('#endDt').value=toLocalDatetimeValue(now);

  $('#btnAutoXlsx').addEventListener('click', async ()=>{ try{ await tryAutoLoadExcel(); }catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; } });
  $('#fileXlsx').addEventListener('change', async ev=>{
    const f=ev.target.files?.[0]; if(!f) return;
    try{ const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); loadFromWorkbook(wb); }
    catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; }
  });

  $('#btnFetch').addEventListener('click', async ()=>{
    if(!stations.length){ alert('Chưa nạp danh sách trạm từ Excel.'); return; }
    const pass=$('#passcode').value.trim();
    let s=new Date($('#startDt').value), e=new Date($('#endDt').value);
    if(!(s.getTime()<e.getTime())){ alert('Khoảng thời gian không hợp lệ.'); return; }

    const indices=Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
    if(!indices.length){ alert('Hãy chọn ít nhất 1 trạm.'); return; }

    const tinhtong=$('#tinhtong').checked?1:0;
    if(tinhtong===1){
      s.setHours(0,0,0,0); e.setHours(23,59,0,0);
      $('#startDt').value=toLocalDatetimeValue(s);
      $('#endDt').value=toLocalDatetimeValue(e);
    }
    const fmt=(dt)=>`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:00`;
    const sStr=fmt(s), eStr=fmt(e);

    const datasets={};
    await Promise.all(indices.map(async idx=>{
      const r=stations[idx];
      const ten_table=($('#tenTable').value.trim()||r.Tab||'mucnuoc_oday');
      const sophut=Number($('#sophut').value||r.sophut||60)||60;
      const params={ matram:r.matram, ten_table, sophut:String(sophut), tinhtong:String(tinhtong),
                     thoigianbd:quote(sStr), thoigiankt:quote(eStr) };
      if(pass) params.passcode=pass;
      const url=buildUrl(params);
      try{
        const resp=await fetch(url,{credentials:'include'});
        const data=await resp.json();
        datasets[r.tentram||r.matram]=Array.isArray(data)?data:[];
      }catch(e){ datasets[r.tentram||r.matram]=[]; console.warn('Fetch lỗi', r.matram, e); }
    }));

    const tableRows=pivotByTime(datasets);
    renderTable(tableRows);
  });

  $('#btnClear').addEventListener('click', ()=>{
    $('#thead').innerHTML=''; $('#tbody').innerHTML='';
  });

  try{ await tryAutoLoadExcel(); }
  catch(e){ $('#xlsxStatus').className='status'; $('#xlsxStatus').textContent='Không tìm thấy file mặc định. Hãy chọn file .xlsx thủ công.'; }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
