<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN - QUẢNG TRỊ</title>
  <style>
    :root { --bg:#f7f9ff; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#1d4ed8; --ok:#16a34a; --err:#dc2626; --grid:#e2e8f0; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--grid);padding:18px 16px;z-index:5}
    .mega-title{margin:0;text-align:center;color:var(--pri);font-weight:800;letter-spacing:.5px}
    .mega-title .l1{font-size:28px;text-transform:uppercase}
    .mega-title .l2{font-size:14px;color:#334155;margin-top:4px}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:12px;color:var(--muted);display:block;margin:4px 0}
    input,select,button{width:100%;padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
    button{background:var(--pri);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#64748b}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted)}
    .status{font-size:12px;margin-top:6px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{font-size:11px;background:#e2e8f0;color:#334155;border-radius:999px;padding:3px 8px}
    .urlbox{font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#f3f4f6;border:1px dashed var(--grid);border-radius:8px;padding:8px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--grid);border-right:1px solid var(--grid);text-align:left;vertical-align:top}
    th:first-child, td:first-child{border-left:1px solid var(--grid)}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
    .grid{display:grid;grid-template-rows:auto 1fr;height:calc(100vh - 160px);gap:12px}
    .scroll{overflow:auto;border:1px solid var(--grid);border-radius:8px;background:#fff}
    footer{padding:10px 16px;font-size:12px;color:#6b7280}
    .hide{display:none}
    #multiSelect{height:200px}
    @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1 class="mega-title">
    <span class="l1">THÔNG TIN MỰC NƯỚC CÁC TRẠM THỦY VĂN TRÊN ĐỊA BÀN TỈNH QUẢNG TRỊ</span>
    <span class="l2">Phục vụ công tác phòng chống thiên tai</span>
  </h1>
</header>

<div class="wrap">
  <section class="card">
    <div class="row">
      <button id="btnAutoXlsx">Tải tự động</button>
      <input type="file" id="fileXlsx" accept=".xlsx" />
    </div>
    <div id="xlsxStatus" class="status">Chưa tải file Excel.</div>
    <div class="hint">Đặt <b>index.html</b> cùng thư mục với <b>thamso_khaithac.xlsx</b> rồi bấm “Tải tự động”; hoặc chọn file thủ công. Không đổi tên cột: <code>matram, tentram, matinh, Tab, sophut, tinhtong</code>.</div>

    <div style="margin-top:10px">
      <label>Passcode (nếu API yêu cầu)</label>
      <input id="passcode" type="text" placeholder="để trống nếu không cần">
    </div>

    <hr>

    <div class="row">
      <div>
        <label>Chế độ bảng nhiều trạm</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="multiMode" checked> Bật (giống ảnh mẫu)</label>
      </div>
      <div>
        <label>Hiện đồ thị (chỉ ở 1 trạm)</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="toggleChart"> Bật</label>
      </div>
    </div>

    <div id="singleStationBox" class="hide">
      <label>Chọn trạm (1 trạm)</label>
      <select id="stationSelect"></select>
      <div id="stationChips" class="chips"></div>
    </div>

    <div id="multiStationBox">
      <label>Chọn các trạm (Giữ Ctrl/Shift để chọn nhiều)</label>
      <select id="multiSelect" multiple></select>
      <div class="hint">Mặc định chọn 4 trạm đầu tiên. Có thể chọn tối đa 10 trạm để bảng không quá rộng.</div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Bắt đầu</label><input type="datetime-local" id="startDt"></div>
      <div><label>Kết thúc</label><input type="datetime-local" id="endDt"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Chu kỳ (sophut)</label><input type="number" id="sophut" min="1" step="1" value="60"></div>
      <div><label>ten_table (mặc định lấy theo Excel từng trạm)</label>
        <input id="tenTable" placeholder="để trống để lấy theo Excel">
      </div>
    </div>

    <div style="margin-top:8px"><label><input type="checkbox" id="tinhtong"> Tính tổng theo ngày (tinhtong=1)</label></div>

    <div class="row" style="margin-top:10px">
      <button id="btnFetch">Lấy dữ liệu</button>
      <button class="secondary" id="btnClear">Xoá kết quả</button>
    </div>

    <div style="margin-top:10px">
      <label>Request URL (gần nhất)</label>
      <div class="urlbox" id="urlBox">(chưa gửi)</div>
      <button id="btnOpenUrl" class="secondary" style="margin-top:6px">Mở URL trong tab mới</button>
    </div>

    <div class="status" id="fetchStatus"></div>
  </section>

  <section class="grid">
    <div class="card"><div style="font-weight:700">Kết quả</div><div class="hint">Bảng theo thời gian (cột đầu) và các trạm (cột sau)</div></div>
    <div class="scroll">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="chartWrap" style="display:none;padding:12px"><canvas id="chart" height="120"></canvas></div>
    </div>
  </section>
</div>

<footer>API: <code>http://203.209.181.170:2018/API_TTB/JSON/solieu.php</code></footer>

<script>
/* ====== CẤU HÌNH ====== */
const RAW_API_BASE = "http://203.209.181.170:2018";
const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1") ? "/api" : RAW_API_BASE;
const DEFAULT_XLSX_PATH = "./thamso_khaithac.xlsx";
const EXCEL_SHEET = "KhaibaoQuangtri";

/* ====== TIỆN ÍCH ====== */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,"0");
const toLocalDatetimeValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
const quote = s => `'${s}'`;
const buildUrl = p => `${API_BASE}/API_TTB/JSON/solieu.php?` + new URLSearchParams(p).toString();
async function fetchJSON(url){
  async function doFetch(u){
    const res = await fetch(u, { credentials:'include' });
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${raw.slice(0,200)}`);
    try { return JSON.parse(raw); }
    catch(e){ if (raw.trim().startsWith('<')) throw new Error('Server trả HTML: '+raw.slice(0,160)); throw new Error('Server không trả JSON hợp lệ. '+raw.slice(0,200)); }
  }
  try { return await doFetch(url); }
  catch(err){
    const s = String(err.message||err);
    const needProxy = location.protocol==='file:' || /NetworkError|Failed to fetch|CORS/i.test(s);
    if (needProxy){
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      return await doFetch(proxy);
    }
    throw err;
  }
}

/* ====== ĐỌC EXCEL ====== */
let stations=[];
function normalizeRow(r){
  const pick=(a,b)=> (a!==undefined && a!=='')?a:b;
  return { matram:String(pick(r.matram,r.MATRAM)||'').trim(), tentram:String(pick(r.tentram,r.TENTRAM)||'').trim(), matinh:pick(r.matinh,r.MATINH)||'', Tab:String(pick(r.Tab,r.tab)||'').trim(), sophut:Number(pick(r.sophut,r.SOPHUT)||60)||60, tinhtong:Number(pick(r.tinhtong,r.TINHTONG)||0)||0 };
}
function loadFromWorkbook(wb){
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  stations = arr.map(normalizeRow).filter(r=>r.matram);
  if (!stations.length) throw new Error('Không đọc được danh sách trạm từ Excel.');
  $('#xlsxStatus').className='status ok';
  $('#xlsxStatus').textContent=`Đã nạp ${stations.length} trạm.`;
  fillStationSelects();
}
async function tryAutoLoadExcel(){
  $('#xlsxStatus').textContent='Đang tải thamso_khaithac.xlsx…';
  const res = await fetch(DEFAULT_XLSX_PATH);
  if (!res.ok) throw new Error('Không thấy ./thamso_khaithac.xlsx');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  loadFromWorkbook(wb);
}

/* ====== UI ====== */
function fillStationSelects(){
  const sel1=$('#stationSelect'); const selM=$('#multiSelect'); sel1.innerHTML=''; selM.innerHTML='';
  stations.forEach((r,i)=>{ const o1=document.createElement('option'); o1.value=i; o1.textContent=`${r.tentram||'(không tên)'} — ${r.matram}`; sel1.appendChild(o1); const o2=document.createElement('option'); o2.value=i; o2.textContent=`${r.tentram||'(không tên)'} — ${r.matram}`; selM.appendChild(o2); });
  sel1.selectedIndex=0; for(let i=0;i<Math.min(4,stations.length);i++){ selM.options[i].selected=true; }
  renderStationChips();
}
function renderStationChips(){ const i=Number($('#stationSelect').value||0); const r=stations[i]; const box=$('#stationChips'); if (!box) return; box.innerHTML=''; if(!r) return; [["matram",r.matram],["tentram",r.tentram],["Tab",r.Tab||"(trống)"],["sophut",r.sophut],["tinhtong",r.tinhtong]].forEach(([k,v])=>{ const span=document.createElement('span'); span.className='chip'; span.textContent=`${k}: ${v}`; box.appendChild(span); }); }

function renderTable(rows){ const thead=$('#thead'), tbody=$('#tbody'); thead.innerHTML=''; tbody.innerHTML=''; if(!Array.isArray(rows)||!rows.length){ thead.innerHTML='<th>(trống)</th>'; return; } const cols=Object.keys(rows[0]); thead.innerHTML=cols.map(c=>`<th>${c}</th>`).join(''); const frag=document.createDocumentFragment(); for(const r of rows){ const tr=document.createElement('tr'); tr.innerHTML=cols.map(c=>`<td>${r[c]??''}</td>`).join(''); frag.appendChild(tr);} tbody.appendChild(frag); }

// Helpers for reading time/value keys from API
function pickField(row, keys){ for(const k of keys){ if(row[k]!==undefined && row[k]!==null && row[k]!=='' ) return row[k]; } }
const TIME_KEYS=['thoigian','Thoigian','thoigian_SL','Thoigian_SL','ThoiGian','ThoiGian_SL','time','datetime'];
const VALUE_KEYS=['solieu','SoLieu','Solieu','GiaTri','giatri','mucnuoc','MucNuoc','value'];
const normTime=t=> (t==null?'':String(t).trim().replace('T',' '));

let chart; // (đồ thị chỉ dùng ở 1 trạm; giữ placeholder)

function pivotByTime(datasetMap){
  const timeIndex=new Map();
  const stationNames=Object.keys(datasetMap);
  for(const name of stationNames){
    const rows=datasetMap[name]||[];
    for(const r of rows){
      const t=normTime(pickField(r,TIME_KEYS));
      const v=pickField(r,VALUE_KEYS);
      if(!t) continue;
      if(!timeIndex.has(t)) timeIndex.set(t,{"thoi gian":t});
      timeIndex.get(t)[name]=v;
    }
  }
  const out=Array.from(timeIndex.values());
  out.sort((a,b)=>String(a["thoi gian"]).localeCompare(String(b["thoi gian"])));
  return out.map(r=>{ const obj={"thoi gian":r["thoi gian"]}; for(const n of stationNames){ obj[n]=(r[n]!==undefined?r[n]:""); } return obj; });
}

/* ====== LUỒNG CHÍNH ====== */
async function init(){
  const now=new Date(), start=new Date(now.getTime()-36*3600*1000); $('#startDt').value=toLocalDatetimeValue(start); $('#endDt').value=toLocalDatetimeValue(now);
  $('#stationSelect')?.addEventListener('change', renderStationChips);
  $('#multiMode').addEventListener('change', ()=>{ const multi=$('#multiMode').checked; $('#multiStationBox').classList.toggle('hide', !multi); $('#singleStationBox').classList.toggle('hide', multi); $('#toggleChart').disabled=multi; });
  $('#btnAutoXlsx').addEventListener('click', async ()=>{ try{ await tryAutoLoadExcel(); }catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; } });
  $('#fileXlsx').addEventListener('change', async ev=>{ const f=ev.target.files?.[0]; if(!f) return; try{ const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); loadFromWorkbook(wb); }catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; } });
  $('#btnOpenUrl').addEventListener('click', ()=>{ const u=$('#urlBox').textContent.trim(); if(u.startsWith('http')) window.open(u,'_blank'); });

  $('#btnFetch').addEventListener('click', async ()=>{
    if(!stations.length){ alert('Chưa nạp danh sách trạm từ Excel.'); return; }
    const pass=$('#passcode').value.trim();
    let s=new Date($('#startDt').value), e=new Date($('#endDt').value); if(!(s.getTime()<e.getTime())){ alert('Khoảng thời gian không hợp lệ.'); return; }
    const multi=$('#multiMode').checked;

    if(multi){
      const indices=Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
      if(!indices.length){ alert('Hãy chọn ít nhất 1 trạm.'); return; }
      if(indices.length>10){ alert('Chọn tối đa 10 trạm để bảng không quá rộng.'); return; }
      const tinhtong=$('#tinhtong').checked?1:0; if(tinhtong===1){ s.setHours(0,0,0,0); e.setHours(23,59,0,0); $('#startDt').value=toLocalDatetimeValue(s); $('#endDt').value=toLocalDatetimeValue(e); }
      const sStr=`${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())} ${pad(s.getHours())}:${pad(s.getMinutes())}:00`;
      const eStr=`${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())} ${pad(e.getHours())}:${pad(e.getMinutes())}:00`;

      const datasets={}; $('#fetchStatus').className='status'; $('#fetchStatus').textContent='Đang lấy dữ liệu nhiều trạm…';
      await Promise.all(indices.map(async idx=>{
        const r=stations[idx]; const ten_table=($('#tenTable').value.trim()||r.Tab||'mucnuoc_oday'); const sophut=Number($('#sophut').value||r.sophut||60)||60;
        const params={ matram:r.matram, ten_table, sophut:String(sophut), tinhtong:String(tinhtong), thoigianbd:quote(sStr), thoigiankt:quote(eStr) }; if(pass) params.passcode=pass; const url=buildUrl(params);
        try{ const data=await fetchJSON(url); datasets[r.tentram||r.matram]=Array.isArray(data)?data:[]; }catch(e){ datasets[r.tentram||r.matram]=[]; console.warn('Fetch lỗi', r.matram, e); }
      }));

      const recvSummary=Object.entries(datasets).map(([k,v])=>`${k}: ${v.length}`).join('; ');
      const tableRows=pivotByTime(datasets);
      if(!tableRows.length){ renderTable([]); $('#chartWrap').style.display='none'; $('#fetchStatus').className='status err'; $('#fetchStatus').textContent=`Không ghép được bảng (thiếu cột thời gian/giá trị). Nhận: ${recvSummary}`; return; }
      renderTable(tableRows); $('#chartWrap').style.display='none'; $('#fetchStatus').className='status ok'; $('#fetchStatus').textContent=`Đã ghép ${tableRows.length} mốc thời gian, ${Object.keys(datasets).length} trạm. (${recvSummary})`;
      return;
    }

    // 1 trạm
    const i=Number($('#stationSelect').value||0); const r=stations[i]; const ten_table=($('#tenTable').value.trim()||r.Tab||'mucnuoc_oday'); const sophut=Number($('#sophut').value||r.sophut||60)||60; const tinhtong=$('#tinhtong').checked?1:0; if(tinhtong===1){ s.setHours(0,0,0,0); e.setHours(23,59,0,0); $('#startDt').value=toLocalDatetimeValue(s); $('#endDt').value=toLocalDatetimeValue(e); }
    const sStr=`${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())} ${pad(s.getHours())}:${pad(s.getMinutes())}:00`; const eStr=`${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())} ${pad(e.getHours())}:${pad(e.getMinutes())}:00`;
    const params={ matram:r.matram, ten_table, sophut:String(sophut), tinhtong:String(tinhtong), thoigianbd:quote(sStr), thoigiankt:quote(eStr) }; if(pass) params.passcode=pass; const url=buildUrl(params);
    $('#urlBox').textContent=url; $('#fetchStatus').className='status'; $('#fetchStatus').textContent='Đang lấy dữ liệu…';
    try{ const data=await fetchJSON(url); renderTable(Array.isArray(data)?data:[]); $('#fetchStatus').className='status ok'; $('#fetchStatus').textContent=`Nhận ${Array.isArray(data)?data.length:0} dòng.`; }catch(err){ renderTable([]); $('#fetchStatus').className='status err'; $('#fetchStatus').textContent=String(err.message||err); }
  });

  $('#btnClear').addEventListener('click', ()=>{ $('#thead').innerHTML=''; $('#tbody').innerHTML=''; $('#chartWrap').style.display='none'; $('#urlBox').textContent='(chưa gửi)'; $('#fetchStatus').textContent=''; });

  try{ await tryAutoLoadExcel(); }catch(e){ $('#xlsxStatus').className='status'; $('#xlsxStatus').textContent='Không tìm thấy file mặc định. Hãy chọn file .xlsx thủ công.'; }
  $('#multiMode').dispatchEvent(new Event('change'));
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
